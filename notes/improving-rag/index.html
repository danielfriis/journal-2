<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    
      <title>Improving RAG Performance — Daniel Friis</title>
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <script defer data-domain="danielfriis.com" src="https://plausible.io/js/script.js"></script>
  </head>
  <body class="antialiased max-w-screen-sm px-3 mx-auto mt-2 mb-20 bg-stone-50/50 dark:bg-zinc-900 flex flex-col">
    <header class="pt-10 mb-20 overflow-hidden max-w-72">
      <div class="text-xs font-light text-zinc-400 truncate">
  
  <a href="/">danielfriis.com</a>
  
    
      / <a href="/notes/">notes</a>
    
  
    
      / improving-rag
    
  
</div>
    </header>
    <main aria-label="Content">
      <section class="pt-10 mb-20 flex flex-col">
        <h1 class="text-3xl md:text-4xl font-serif mb-3 dark:text-zinc-300 text-pretty">Improving RAG Performance</h1>
      </section>
      <div class="formatted-content">
  <p class="text-sm">
    
      <time datetime="2024-08-26T11:03:00+00:00">24-08-26</time>
    
    
  </p>
  <div class="pt-6"></div>
  <p>By now, most people working with LLMs have either heard of or worked with RAG (Retrieval-Augmented Generation). However, finding good resources on how to make it work well in practice have been challenging to me. This is why I decided to write this note about my own learnings.</p>

<h2 id="quick-rag-introduction">Quick RAG introduction</h2>

<p>RAG is a technique designed to reduce hallucinations and improve the accuracy of LLMs. Here’s a brief overview of how it works:</p>

<ol>
  <li><strong>Retrieval</strong>: When given a query, the system searches a database of relevant information.</li>
  <li><strong>Augmentation</strong>: The retrieved information is then added to the input prompt.</li>
  <li><strong>Generation</strong>: The AI model uses this augmented prompt to generate a more informed and accurate response.</li>
</ol>

<p><img src="/assets/images/rag-article/basic-rag.svg" alt="RAG Diagram" /></p>

<p>This simple setup works well out of the box, but there are ways to significantly improve its performance.</p>

<h2 id="improving-the-retrieval-step">Improving the Retrieval Step</h2>

<p>In my experience, the limiting factor for good RAG performance is the retrieval step. If you can find the right data, the rest of the system usually generates a good response.</p>

<p>To improve this step, it’s important to understand how vector search works.</p>

<p>When you embed your data, you create a vector (i.e., numerical) representation of the text, which can be thought of as a point in a high-dimensional space. You do the same for your query. Searching means finding the closest points to your query in that space.</p>

<p><img src="/assets/images/rag-article/vector-search.svg" alt="Vector Search Diagram" /></p>

<p>Therefore, one of the most important tasks in improving the retrieval step is to bring your data points and queries closer in the vector space. Doing that means making them more similar to each other.</p>

<p>Very high-level, you can do this either by manipulating the data or the query. Both approaches are worth exploring, but the latter is usually most simple.</p>

<h2 id="query-manipulation">Query Manipulation</h2>

<p>There are several techniques you can use to manipulate the query to get it closer in the vector space to your data points.</p>

<ul>
  <li><strong>Query Expansion</strong>: Adding related terms to the query to cover more ground.</li>
  <li><strong>Hypothetical Document Embeddings</strong>: Creating synthetic documents that represent potential queries.</li>
  <li><strong>Query Rewriting</strong>: Rephrasing the query to better match the data points.</li>
  <li><strong>Multi-Query Retrieval</strong>: Using multiple variations of the query to improve retrieval.</li>
  <li><strong>Query Decomposition</strong>: Breaking down complex queries into simpler sub-queries.</li>
  <li><strong>Query Reformulation</strong>: Iteratively refining the query based on initial retrieval results.</li>
  <li><strong>Contextual Query Expansion</strong>: Expanding the query using context from the surrounding text.</li>
  <li><strong>Query-by-Example</strong>: Using example documents to guide the retrieval process.</li>
</ul>

<p>I’ve found the best results when using a combination of these techniques.</p>

<p>Specifically, I’ve seen the most success by breaking queries into its components (Query Decomposition), generating hypothetical chunks containing the answer (Hypothetical Document Embeddings), and running the generated queries in parallel (Multi-Query Retrieval). This returns a set of arrays of chunks, which I then rank by their distance to each query to generate a single ranked list of chunks.</p>

<p>It looks something like this:</p>

<p><img src="/assets/images/rag-article/query-manipulation.svg" alt="Multi-Query Retrieval Diagram" /></p>

<p>That’s it! I’ve found that this approach significantly improves the retrieval step and leads to better overall RAG performance. If you have any other tips for improving RAG performance, feel free to reach out!</p>

</div>
<div class="pt-20 flex flex-col gap-y-20">
  <p class="text-xs font-light text-zinc-400 dark:text-zinc-400">
    There will be typos, half-baked ideas, and opinions presented as facts here. I'm not a professional writer, and I'm not trying to be one. I'm writing these notes as an exercise to clarify my thinking and to archive insights worth revisiting. If you find it useful, that's great. If you don't, that's fine too.
  </p>
  <div class="text-xs font-light text-zinc-400 dark:text-zinc-400 flex flex-row gap-x-3">
    <p>Read other <a class="text-zinc-800/90 hover:text-black dark:text-zinc-300 dark:hover:text-white" href="/notes">notes</a> or go <a class="text-zinc-800/90 hover:text-black dark:text-zinc-300 dark:hover:text-white" href="/">home</a>.</p>
  </div>
</div>

    </main>
    <footer class="mt-20">
      <span class="text-xs font-light text-zinc-400">
        &COPY; 2024
        <a href="/">
          Daniel Friis
        </a>
      </span>
    </footer>
  </body>
</html>
